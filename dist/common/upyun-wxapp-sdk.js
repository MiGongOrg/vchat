'use strict';

function Upyun(options) {
  this.bucket = options.bucket;
  this.operator = options.operator;
  this.getSignatureUrl = options.getSignatureUrl;
}

Upyun.prototype.upload = function (options) {
  var self = this;
  if (!options.remotePath) {
    options.remotePath = options.localPath.split('//')[1];
  }
  var date = new Date().toGMTString();
  var opts = {
    'save-key': options.remotePath,
    bucket: self.bucket,
    expiration: Math.round(new Date().getTime() / 1000) + 3600,
    date: date
  };
  var policy = Base64.encode(JSON.stringify(opts));
  var data = ['POST', '/' + self.bucket, date, policy].join('&');
  self.getSignature(data, function (err, signature) {
    if (err) {
      options.fail && options.fail(err);
      options.complete && options.complete(err);
      return;
    }
    wx.uploadFile({
      url: 'https://v0.api.upyun.com/' + self.bucket,
      filePath: options.localPath,
      name: 'file',
      formData: {
        authorization: 'UPYUN ' + self.operator + ':' + signature,
        policy: policy
      },
      success: options.success,
      fail: options.fail,
      complete: options.complete
    });
  });
};

Upyun.prototype.getSignature = function (data, cb) {
  wx.request({
    url: this.getSignatureUrl,
    data: {
      data: data
    },
    success: function success(res) {
      cb(null, res.data.signature);
    },
    fail: function fail(err) {
      cb(err);
    }
  });
};

/* eslint-disable */
var Base64 = {
  // private property
  _keyStr: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=',
  // public method for encoding
  encode: function encode(input) {
    var output = '';
    var chr1, chr2, chr3, enc1, enc2, enc3, enc4;
    var i = 0;
    input = Base64._utf8_encode(input);
    while (i < input.length) {
      chr1 = input.charCodeAt(i++);
      chr2 = input.charCodeAt(i++);
      chr3 = input.charCodeAt(i++);
      enc1 = chr1 >> 2;
      enc2 = (chr1 & 3) << 4 | chr2 >> 4;
      enc3 = (chr2 & 15) << 2 | chr3 >> 6;
      enc4 = chr3 & 63;
      if (isNaN(chr2)) {
        enc3 = enc4 = 64;
      } else if (isNaN(chr3)) {
        enc4 = 64;
      }
      output = output + this._keyStr.charAt(enc1) + this._keyStr.charAt(enc2) + this._keyStr.charAt(enc3) + this._keyStr.charAt(enc4);
    }
    return output;
  },
  // public method for decoding
  decode: function decode(input) {
    var output = '';
    var chr1, chr2, chr3;
    var enc1, enc2, enc3, enc4;
    var i = 0;
    input = input.replace(/[^A-Za-z0-9\+\/\=]/g, '');
    while (i < input.length) {
      enc1 = this._keyStr.indexOf(input.charAt(i++));
      enc2 = this._keyStr.indexOf(input.charAt(i++));
      enc3 = this._keyStr.indexOf(input.charAt(i++));
      enc4 = this._keyStr.indexOf(input.charAt(i++));
      chr1 = enc1 << 2 | enc2 >> 4;
      chr2 = (enc2 & 15) << 4 | enc3 >> 2;
      chr3 = (enc3 & 3) << 6 | enc4;
      output = output + String.fromCharCode(chr1);
      if (enc3 != 64) {
        output = output + String.fromCharCode(chr2);
      }
      if (enc4 != 64) {
        output = output + String.fromCharCode(chr3);
      }
    }
    output = Base64._utf8_decode(output);
    return output;
  },
  // private method for UTF-8 encoding
  _utf8_encode: function _utf8_encode(string) {
    string = string.replace(/\r\n/g, '\n');
    var utftext = '';
    for (var n = 0; n < string.length; n++) {
      var c = string.charCodeAt(n);
      if (c < 128) {
        utftext += String.fromCharCode(c);
      } else if (c > 127 && c < 2048) {
        utftext += String.fromCharCode(c >> 6 | 192);
        utftext += String.fromCharCode(c & 63 | 128);
      } else {
        utftext += String.fromCharCode(c >> 12 | 224);
        utftext += String.fromCharCode(c >> 6 & 63 | 128);
        utftext += String.fromCharCode(c & 63 | 128);
      }
    }
    return utftext;
  },
  // private method for UTF-8 decoding
  _utf8_decode: function _utf8_decode(utftext) {
    var string = '';
    var i = 0;
    var c = c1 = c2 = 0;
    while (i < utftext.length) {
      c = utftext.charCodeAt(i);
      if (c < 128) {
        string += String.fromCharCode(c);
        i++;
      } else if (c > 191 && c < 224) {
        c2 = utftext.charCodeAt(i + 1);
        string += String.fromCharCode((c & 31) << 6 | c2 & 63);
        i += 2;
      } else {
        c2 = utftext.charCodeAt(i + 1);
        c3 = utftext.charCodeAt(i + 2);
        string += String.fromCharCode((c & 15) << 12 | (c2 & 63) << 6 | c3 & 63);
        i += 3;
      }
    }
    return string;
  }
  /* eslint-enable */

};module.exports = Upyun;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInVweXVuLXd4YXBwLXNkay5qcyJdLCJuYW1lcyI6WyJVcHl1biIsIm9wdGlvbnMiLCJidWNrZXQiLCJvcGVyYXRvciIsImdldFNpZ25hdHVyZVVybCIsInByb3RvdHlwZSIsInVwbG9hZCIsInNlbGYiLCJyZW1vdGVQYXRoIiwibG9jYWxQYXRoIiwic3BsaXQiLCJkYXRlIiwiRGF0ZSIsInRvR01UU3RyaW5nIiwib3B0cyIsImV4cGlyYXRpb24iLCJNYXRoIiwicm91bmQiLCJnZXRUaW1lIiwicG9saWN5IiwiQmFzZTY0IiwiZW5jb2RlIiwiSlNPTiIsInN0cmluZ2lmeSIsImRhdGEiLCJqb2luIiwiZ2V0U2lnbmF0dXJlIiwiZXJyIiwic2lnbmF0dXJlIiwiZmFpbCIsImNvbXBsZXRlIiwid3giLCJ1cGxvYWRGaWxlIiwidXJsIiwiZmlsZVBhdGgiLCJuYW1lIiwiZm9ybURhdGEiLCJhdXRob3JpemF0aW9uIiwic3VjY2VzcyIsImNiIiwicmVxdWVzdCIsInJlcyIsIl9rZXlTdHIiLCJpbnB1dCIsIm91dHB1dCIsImNocjEiLCJjaHIyIiwiY2hyMyIsImVuYzEiLCJlbmMyIiwiZW5jMyIsImVuYzQiLCJpIiwiX3V0ZjhfZW5jb2RlIiwibGVuZ3RoIiwiY2hhckNvZGVBdCIsImlzTmFOIiwiY2hhckF0IiwiZGVjb2RlIiwicmVwbGFjZSIsImluZGV4T2YiLCJTdHJpbmciLCJmcm9tQ2hhckNvZGUiLCJfdXRmOF9kZWNvZGUiLCJzdHJpbmciLCJ1dGZ0ZXh0IiwibiIsImMiLCJjMSIsImMyIiwiYzMiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOztBQUFBLFNBQVNBLEtBQVQsQ0FBZ0JDLE9BQWhCLEVBQXlCO0FBQ3ZCLE9BQUtDLE1BQUwsR0FBY0QsUUFBUUMsTUFBdEI7QUFDQSxPQUFLQyxRQUFMLEdBQWdCRixRQUFRRSxRQUF4QjtBQUNBLE9BQUtDLGVBQUwsR0FBdUJILFFBQVFHLGVBQS9CO0FBQ0Q7O0FBRURKLE1BQU1LLFNBQU4sQ0FB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LENBQW1CSCxJQUFJLENBQXZCLENBQUw7QUFDQVksa0JBQVVILE9BQU9DLFlBQVAsQ0FBcUIsQ0FBQ0ssSUFBSSxFQUFMLEtBQVksRUFBYixHQUFvQixDQUFDRSxLQUFLLEVBQU4sS0FBYSxDQUFqQyxHQUF1Q0MsS0FBSyxFQUFoRSxDQUFWO0FBQ0FsQixhQUFLLENBQUw7QUFDRDtBQUNGO0FBQ0QsV0FBT1ksTUFBUDtBQUNEO0FBRUg7O0FBakdhLENBQWIsQ0FtR0FPLE9BQU9DLE9BQVAsR0FBaUJ4RSxLQUFqQiIsImZpbGUiOiJ1cHl1bi13eGFwcC1zZGsuanMiLCJzb3VyY2VzQ29udGVudCI6WyJmdW5jdGlvbiBVcHl1biAob3B0aW9ucykge1xuICB0aGlzLmJ1Y2tldCA9IG9wdGlvbnMuYnVja2V0XG4gIHRoaXMub3BlcmF0b3IgPSBvcHRpb25zLm9wZXJhdG9yXG4gIHRoaXMuZ2V0U2lnbmF0dXJlVXJsID0gb3B0aW9ucy5nZXRTaWduYXR1cmVVcmxcbn1cblxuVXB5dW4ucHJvdG90eXBlLnVwbG9hZCA9IGZ1bmN0aW9uIChvcHRpb25zKSB7XG4gIHZhciBzZWxmID0gdGhpc1xuICBpZiAoIW9wdGlvbnMucmVtb3RlUGF0aCkge1xuICAgIG9wdGlvbnMucmVtb3RlUGF0aCA9IG9wdGlvbnMubG9jYWxQYXRoLnNwbGl0KCcvLycpWzFdXG4gIH1cbiAgdmFyIGRhdGUgPSAobmV3IERhdGUoKSkudG9HTVRTdHJpbmcoKVxuICB2YXIgb3B0cyA9IHtcbiAgICAnc2F2ZS1rZXknOiBvcHRpb25zLnJlbW90ZVBhdGgsXG4gICAgYnVja2V0OiBzZWxmLmJ1Y2tldCxcbiAgICBleHBpcmF0aW9uOiBNYXRoLnJvdW5kKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC8gMTAwMCkgKyAzNjAwLFxuICAgIGRhdGU6IGRhdGVcbiAgfVxuICB2YXIgcG9saWN5ID0gQmFzZTY0LmVuY29kZShKU09OLnN0cmluZ2lmeShvcHRzKSlcbiAgdmFyIGRhdGEgPSBbICdQT1NUJywgJy8nICsgc2VsZi5idWNrZXQsIGRhdGUsIHBvbGljeSBdLmpvaW4oJyYnKVxuICBzZWxmLmdldFNpZ25hdHVyZShkYXRhLCBmdW5jdGlvbiAoZXJyLCBzaWduYXR1cmUpIHtcbiAgICBpZiAoZXJyKSB7XG4gICAgICBvcHRpb25zLmZhaWwgJiYgb3B0aW9ucy5mYWlsKGVycilcbiAgICAgIG9wdGlvbnMuY29tcGxldGUgJiYgb3B0aW9ucy5jb21wbGV0ZShlcnIpXG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgd3gudXBsb2FkRmlsZSh7XG4gICAgICB1cmw6IGBodHRwczovL3YwLmFwaS51cHl1bi5jb20vJHtzZWxmLmJ1Y2tldH1gLFxuICAgICAgZmlsZVBhdGg6IG9wdGlvbnMubG9jYWxQYXRoLFxuICAgICAgbmFtZTogJ2ZpbGUnLFxuICAgICAgZm9ybURhdGE6IHtcbiAgICAgICAgYXV0aG9yaXphdGlvbjogYFVQWVVOICR7c2VsZi5vcGVyYXRvcn06JHtzaWduYXR1cmV9YCxcbiAgICAgICAgcG9saWN5OiBwb2xpY3lcbiAgICAgIH0sXG4gICAgICBzdWNjZXNzOiBvcHRpb25zLnN1Y2Nlc3MsXG4gICAgICBmYWlsOiBvcHRpb25zLmZhaWwsXG4gICAgICBjb21wbGV0ZTogb3B0aW9ucy5jb21wbGV0ZVxuICAgIH0pXG4gIH0pXG59XG5cblVweXVuLnByb3RvdHlwZS5nZXRTaWduYXR1cmUgPSBmdW5jdGlvbiAoZGF0YSwgY2IpIHtcbiAgd3gucmVxdWVzdCh7XG4gICAgdXJsOiB0aGlzLmdldFNpZ25hdHVyZVVybCxcbiAgICBkYXRhOiB7XG4gICAgICBkYXRhOiBkYXRhXG4gICAgfSxcbiAgICBzdWNjZXNzOiBmdW5jdGlvbiAocmVzKSB7XG4gICAgICBjYihudWxsLCByZXMuZGF0YS5zaWduYXR1cmUpXG4gICAgfSxcbiAgICBmYWlsOiBmdW5jdGlvbiAoZXJyKSB7XG4gICAgICBjYihlcnIpXG4gICAgfVxuICB9KVxufVxuXG4vKiBlc2xpbnQtZGlzYWJsZSAqL1xudmFyIEJhc2U2NCA9IHtcbiAgLy8gcHJpdmF0ZSBwcm9wZXJ0eVxuICBfa2V5U3RyOiAnQUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVphYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5ejAxMjM0NTY3ODkrLz0nLFxuICAvLyBwdWJsaWMgbWV0aG9kIGZvciBlbmNvZGluZ1xuICBlbmNvZGU6IGZ1bmN0aW9uIChpbnB1dCkge1xuICAgIHZhciBvdXRwdXQgPSAnJ1xuICAgIHZhciBjaHIxLCBjaHIyLCBjaHIzLCBlbmMxLCBlbmMyLCBlbmMzLCBlbmM0XG4gICAgdmFyIGkgPSAwXG4gICAgaW5wdXQgPSBCYXNlNjQuX3V0ZjhfZW5jb2RlKGlucHV0KVxuICAgIHdoaWxlIChpIDwgaW5wdXQubGVuZ3RoKSB7XG4gICAgICBjaHIxID0gaW5wdXQuY2hhckNvZGVBdChpKyspXG4gICAgICBjaHIyID0gaW5wdXQuY2hhckNvZGVBdChpKyspXG4gICAgICBjaHIzID0gaW5wdXQuY2hhckNvZGVBdChpKyspXG4gICAgICBlbmMxID0gY2hyMSA+PiAyXG4gICAgICBlbmMyID0gKChjaHIxICYgMykgPDwgNCkgfCAoY2hyMiA+PiA0KVxuICAgICAgZW5jMyA9ICgoY2hyMiAmIDE1KSA8PCAyKSB8IChjaHIzID4+IDYpXG4gICAgICBlbmM0ID0gY2hyMyAmIDYzXG4gICAgICBpZiAoaXNOYU4oY2hyMikpIHtcbiAgICAgICAgZW5jMyA9IGVuYzQgPSA2NFxuICAgICAgfSBlbHNlIGlmIChpc05hTihjaHIzKSkge1xuICAgICAgICBlbmM0ID0gNjRcbiAgICAgIH1cbiAgICAgIG91dHB1dCA9IG91dHB1dCArXG4gICAgICAgIHRoaXMuX2tleVN0ci5jaGFyQXQoZW5jMSkgKyB0aGlzLl9rZXlTdHIuY2hhckF0KGVuYzIpICtcbiAgICAgICAgdGhpcy5fa2V5U3RyLmNoYXJBdChlbmMzKSArIHRoaXMuX2tleVN0ci5jaGFyQXQoZW5jNClcbiAgICB9XG4gICAgcmV0dXJuIG91dHB1dFxuICB9LFxuICAvLyBwdWJsaWMgbWV0aG9kIGZvciBkZWNvZGluZ1xuICBkZWNvZGU6IGZ1bmN0aW9uIChpbnB1dCkge1xuICAgIHZhciBvdXRwdXQgPSAnJ1xuICAgIHZhciBjaHIxLCBjaHIyLCBjaHIzXG4gICAgdmFyIGVuYzEsIGVuYzIsIGVuYzMsIGVuYzRcbiAgICB2YXIgaSA9IDBcbiAgICBpbnB1dCA9IGlucHV0LnJlcGxhY2UoL1teQS1aYS16MC05XFwrXFwvXFw9XS9nLCAnJylcbiAgICB3aGlsZSAoaSA8IGlucHV0Lmxlbmd0aCkge1xuICAgICAgZW5jMSA9IHRoaXMuX2tleVN0ci5pbmRleE9mKGlucHV0LmNoYXJBdChpKyspKVxuICAgICAgZW5jMiA9IHRoaXMuX2tleVN0ci5pbmRleE9mKGlucHV0LmNoYXJBdChpKyspKVxuICAgICAgZW5jMyA9IHRoaXMuX2tleVN0ci5pbmRleE9mKGlucHV0LmNoYXJBdChpKyspKVxuICAgICAgZW5jNCA9IHRoaXMuX2tleVN0ci5pbmRleE9mKGlucHV0LmNoYXJBdChpKyspKVxuICAgICAgY2hyMSA9IChlbmMxIDw8IDIpIHwgKGVuYzIgPj4gNClcbiAgICAgIGNocjIgPSAoKGVuYzIgJiAxNSkgPDwgNCkgfCAoZW5jMyA+PiAyKVxuICAgICAgY2hyMyA9ICgoZW5jMyAmIDMpIDw8IDYpIHwgZW5jNFxuICAgICAgb3V0cHV0ID0gb3V0cHV0ICsgU3RyaW5nLmZyb21DaGFyQ29kZShjaHIxKVxuICAgICAgaWYgKGVuYzMgIT0gNjQpIHtcbiAgICAgICAgb3V0cHV0ID0gb3V0cHV0ICsgU3RyaW5nLmZyb21DaGFyQ29kZShjaHIyKVxuICAgICAgfVxuICAgICAgaWYgKGVuYzQgIT0gNjQpIHtcbiAgICAgICAgb3V0cHV0ID0gb3V0cHV0ICsgU3RyaW5nLmZyb21DaGFyQ29kZShjaHIzKVxuICAgICAgfVxuICAgIH1cbiAgICBvdXRwdXQgPSBCYXNlNjQuX3V0ZjhfZGVjb2RlKG91dHB1dClcbiAgICByZXR1cm4gb3V0cHV0XG4gIH0sXG4gIC8vIHByaXZhdGUgbWV0aG9kIGZvciBVVEYtOCBlbmNvZGluZ1xuICBfdXRmOF9lbmNvZGU6IGZ1bmN0aW9uIChzdHJpbmcpIHtcbiAgICBzdHJpbmcgPSBzdHJpbmcucmVwbGFjZSgvXFxyXFxuL2csICdcXG4nKVxuICAgIHZhciB1dGZ0ZXh0ID0gJydcbiAgICBmb3IgKHZhciBuID0gMDsgbiA8IHN0cmluZy5sZW5ndGg7IG4rKykge1xuICAgICAgdmFyIGMgPSBzdHJpbmcuY2hhckNvZGVBdChuKVxuICAgICAgaWYgKGMgPCAxMjgpIHtcbiAgICAgICAgdXRmdGV4dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGMpXG4gICAgICB9IGVsc2UgaWYgKChjID4gMTI3KSAmJiAoYyA8IDIwNDgpKSB7XG4gICAgICAgIHV0ZnRleHQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgoYyA+PiA2KSB8IDE5MilcbiAgICAgICAgdXRmdGV4dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKChjICYgNjMpIHwgMTI4KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdXRmdGV4dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKChjID4+IDEyKSB8IDIyNClcbiAgICAgICAgdXRmdGV4dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKCgoYyA+PiA2KSAmIDYzKSB8IDEyOClcbiAgICAgICAgdXRmdGV4dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKChjICYgNjMpIHwgMTI4KVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdXRmdGV4dFxuICB9LFxuICAvLyBwcml2YXRlIG1ldGhvZCBmb3IgVVRGLTggZGVjb2RpbmdcbiAgX3V0ZjhfZGVjb2RlOiBmdW5jdGlvbiAodXRmdGV4dCkge1xuICAgIHZhciBzdHJpbmcgPSAnJ1xuICAgIHZhciBpID0gMFxuICAgIHZhciBjID0gYzEgPSBjMiA9IDBcbiAgICB3aGlsZSAoaSA8IHV0ZnRleHQubGVuZ3RoKSB7XG4gICAgICBjID0gdXRmdGV4dC5jaGFyQ29kZUF0KGkpXG4gICAgICBpZiAoYyA8IDEyOCkge1xuICAgICAgICBzdHJpbmcgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShjKVxuICAgICAgICBpKytcbiAgICAgIH0gZWxzZSBpZiAoKGMgPiAxOTEpICYmIChjIDwgMjI0KSkge1xuICAgICAgICBjMiA9IHV0ZnRleHQuY2hhckNvZGVBdChpICsgMSlcbiAgICAgICAgc3RyaW5nICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoKChjICYgMzEpIDw8IDYpIHwgKGMyICYgNjMpKVxuICAgICAgICBpICs9IDJcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGMyID0gdXRmdGV4dC5jaGFyQ29kZUF0KGkgKyAxKVxuICAgICAgICBjMyA9IHV0ZnRleHQuY2hhckNvZGVBdChpICsgMilcbiAgICAgICAgc3RyaW5nICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoKChjICYgMTUpIDw8IDEyKSB8ICgoYzIgJiA2MykgPDwgNikgfCAoYzMgJiA2MykpXG4gICAgICAgIGkgKz0gM1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gc3RyaW5nXG4gIH1cbn1cbi8qIGVzbGludC1lbmFibGUgKi9cblxubW9kdWxlLmV4cG9ydHMgPSBVcHl1blxuIl19